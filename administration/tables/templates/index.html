{% load booking_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tables</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}" />
</head>
<body>
    <!-- Tooltip div -->
    <div id="tooltip" style="
        position:absolute;
        display:none;
        pointer-events:none;
        background:#333;
        color:#fff;
        padding:6px 10px;
        border-radius:4px;
        font-size:14px;
        z-index:10000;
        white-space: nowrap;"></div>

    <nav class="navigation">
        <h1><a href="{% url 'index' %}">Tables</a></h1>
        <div style="margin-left: 20px; display: inline-block;">
            <a href="{% url 'add_booking' %}">Add</a>
            <a href="{% url 'delete_booking' %}">Delete</a>
        </div>
    </nav>

    <div id="message">Room not available! Couldn't add booking.</div>

    <div style="overflow-x: auto; width: 100vw;">
        <table>
            <thead>
                <tr>
                    <th colspan="32" style="text-align: left;">August</th>
                </tr>
                <tr>
                    <th>Room Number</th>
                    <!-- Days 1-31 -->
                    <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                    <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
                    <th>11</th><th>12</th><th>13</th><th>14</th><th>15</th>
                    <th>16</th><th>17</th><th>18</th><th>19</th><th>20</th>
                    <th>21</th><th>22</th><th>23</th><th>24</th><th>25</th>
                    <th>26</th><th>27</th><th>28</th><th>29</th><th>30</th>
                    <th>31</th>
                </tr>
            </thead>
            <tbody>
                {% for room in rooms %}
                <tr>
                    <td>Room {{ room.room_number }}</td>
                    {% for day in days %}
                        {% with booking=room.booking_set.all|get_booking_for_day:day %}
                            {% if booking %}
                                {% if day == booking.check_in_date.day %}
                                    <td colspan="{{ booking.duration }}" 
                                        class="booking"
                                        style="background-color: #e3f2fd;
                                            border-left: 2px solid #2196f3;
                                            border-right: 2px solid #2196f3;
                                            text-align: center;">
                                        {{ booking.guest_name }}
                                    </td>
                                {% endif %}
                            {% else %}
                                <td></td>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            // Show error message if ?error=notavailable in URL
            const msg = document.getElementById('message');
            if (window.location.search.includes('error=notavailable')) {
                msg.classList.add('show');
                setTimeout(() => {
                    msg.classList.remove('show');
                }, 4000);
            }

            // Tooltip logic
            const tooltip = document.getElementById('tooltip');
            document.querySelectorAll('.booking').forEach(cell => {
                cell.addEventListener('mousemove', e => {
                    const guestName = cell.textContent.trim() || 'Booked';
                    tooltip.style.left = (e.pageX + 15) + 'px';
                    tooltip.style.top = (e.pageY + 15) + 'px';
                    tooltip.textContent = guestName;
                    tooltip.style.display = 'block';
                });
                cell.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        });
    </script>
</body>
</html>
